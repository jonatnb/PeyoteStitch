<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peyote Pattern Maker — Delica FULL (v3.4)</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #previewPane, #cropper { padding:12px 16px; background:#fff; border-bottom:1px solid #e5e7eb }
    #previewRow{display:flex;gap:16px;flex-wrap:wrap}
    .prevBox{background:#fff;border:1px solid #e5e7eb;padding:8px;width:280px}
    .prevTitle{font-weight:600;margin-bottom:6px}
    #origPreview{max-width:100%;height:auto;border:1px solid #e5e7eb;background:#f8fafc}
    #cropThumb{border:1px solid #e5e7eb;background:#f8fafc;max-width:100%}
    #cropCanvas{max-width:100%;border:1px solid #e5e7eb;background:#f8fafc}
  </style>

  <style>
    #assist{padding:12px 16px;background:#fff;border-bottom:1px solid #e5e7eb}
    #assistRow{display:flex;gap:16px;flex-wrap:wrap}
    #loupe,#beadSim{border:1px solid #e5e7eb;background:#f8fafc;max-width:100%}
  </style>

  <style>
    /* Improve touch interactions on crop canvas */
    #cropCanvas{ touch-action: none; }
  </style>
</head>
<body>
  <header>
    <h1>Peyote Pattern Maker <span style='font-size:12px; font-weight:600; padding:2px 6px; border:1px solid #e5e7eb; border-radius:6px; background:#f3f4f6; color:#111; vertical-align:middle;'>v3.5.2</span></h1>
    <p>Photo → peyote grid → <strong>Delica FULL</strong> mapping • Fixed bead: Delica 11/0.</p>
  </header>

  <section id="controls">
    <div class="control">
      <label>Image</label>
      <input type="file" id="file" accept="image/*" />
    </div>

    <div class="control">
      <label>Bead width</label>
      <input type="number" id="beadWidth" min="0" max="400" value="90" />
      <label class="small"><input type="checkbox" id="autoWidth"> Auto</label>
    </div>

    <div class="control">
      <label>Bead height</label>
      <input type="number" id="beadHeight" min="0" max="400" value="0" />
      <label class="small"><input type="checkbox" id="autoHeight" checked> Auto</label>
    </div>

    <div class="control">
      <label># Colors</label>
      <input type="number" id="kColors" min="2" max="64" value="12" />
    </div>

    <div class="control">
      <label>Mapping mode</label>
      <select id="mapMode">
        <option value="palette_fit" selected>Palette-fit (best 10–12 Delica)</option>
        <option value="quantize_then_map">Quantize → Map to Delica</option>
        <option value="direct_to_palette">Direct to Delica (no quantize)</option>
      </select>
      <span class="small">Palette-fit is tuned for 10–12 colors.</span>
    </div>

    <div class="control">
      <label>Cell px</label>
      <input type="number" id="cellPx" min="6" max="30" value="14" />
      <label><input type="checkbox" id="showGrid" checked /> Grid</label>
      <label><input type="checkbox" id="brickOffset" checked /> Peyote offset</label>
    </div>

    <div class="control">
      <label><input type="checkbox" id="lockAspect" checked> Lock aspect (avoid stretch)</label>
    </div>

    <div class="control">
      <strong>Bead size:</strong> Delica 11/0 (fixed) — ~1.6 × 1.3 mm
    </div>
    <div class="control">
      <label>Shrinkage</label>
      <input type="range" id="shrinkPct" min="0" max="15" value="0" />
      <span id="shrinkLabel" class="small">0%</span>
    </div>
    <div class="control">
      <div id="finalSize" class="small">Final size: —</div>
    </div>

    <div class="control">
      <button id="btnGenerate">Generate</button>
      <button id="btnDownloadPNG" disabled>Download PNG</button>
      <button id="btnDownloadJSON" disabled>Legend JSON</button>
      <button id="btnDownloadCSV" disabled>Legend CSV</button>
    </div>
  </section>

  <section id="previewPane">
    <h3>Image Preview</h3>
    <div id="previewRow">
      <div class="prevBox">
        <div class="prevTitle">Original</div>
        <img id="origPreview" alt="original preview" />
        <div id="fileInfo" class="small"></div>
      </div>
      <div class="prevBox">
        <div class="prevTitle">Crop</div>
        <canvas id="cropThumb" width="240" height="160"></canvas>
        <div class="small">Live preview of the selected region</div>
      </div>
    </div>
  </section>

  <section id="assist">
    <h3>Assist Previews</h3>
    <div id="assistRow">
      <div class="prevBox">
        <div class="prevTitle">Zoom (loupe)</div>
        <canvas id="loupe" width="140" height="140"></canvas>
        <div class="small">Zoomed view of the crop</div>
      </div>
      <div class="prevBox">
        <div class="prevTitle">Bead view</div>
        <canvas id="beadSim" width="260" height="180"></canvas>
        <div class="small">Quick simulated beads of the crop</div>
      </div>
    </div>
  </section>

  <section id="cropper">
    <h3>Crop</h3>
    <p class="small">Drag the box or its corners to select the part of the photo to convert.</p>
    <div class="control">
      <button id="btnResetCrop">Reset Crop</button>
      <label class="small"><input type="checkbox" id="lockCropAspect"> Lock crop to bead aspect</label>
      <span id="cropAspectLabel" class="small"></span>
    </div>
    <canvas id="cropCanvas" width="600" height="360"></canvas>
  </section>

  <main>
    <div id="canvasWrap">
      <canvas id="preview" width="1200" height="800"></canvas>
    </div>
    <aside id="legend"></aside>
  </main>

  <footer>
    <p>Palette file: <code>palettes/delica_full.json</code> (locked). Replace with your official list anytime.</p>
  </footer>

  <script src="main.js"></script>
</body>
</html>
